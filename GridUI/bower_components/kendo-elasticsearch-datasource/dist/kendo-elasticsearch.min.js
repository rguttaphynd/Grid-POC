!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("kendo-elasticsearch",[],t):"object"==typeof exports?exports["kendo-elasticsearch"]=t():e["kendo-elasticsearch"]=t()}(this,function(){return function(e){function t(n){if(r[n])return r[n].exports;var s=r[n]={exports:{},id:n,loaded:!1};return e[n].call(s.exports,s,s.exports,t),s.loaded=!0,s.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){"use strict";function n(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t["default"]=e,t}var s=function(){function e(e,t){var r=[],n=!0,s=!1,a=void 0;try{for(var i,o=e[Symbol.iterator]();!(n=(i=o.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(u){s=!0,a=u}finally{try{!n&&o["return"]&&o["return"]()}finally{if(s)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=r(1),i=n(a),o=r(2),u=n(o),l=r(3),d=n(l),f=r(6),c=n(f),g=r(4),p=n(g),h=r(5),y=n(h),m=r(7),v=n(m),_=kendo.data;_.ElasticSearchDataSource=_.DataSource.extend({init:function(e){if(!e)throw new Error("Options are required to use ElasticSearchDataSource");if(!(e.transport&&e.transport.read&&e.transport.read.url))throw new Error("transport.read.url must be set to use ElasticSearchDataSource");var t=e.transport.read;t.dataType=t.dataType||"json",t.method=t.method||"POST",t.contentType=t.contentType||"application/json";var r=e.schema&&e.schema.model;if(!r)throw new Error("transport.schema.model must be set to use ElasticSearchDataSource");if(r.esMapping)r.fields=r.fields||{},_.ElasticSearchDataSource.kendoFieldsFromESMapping(r.esMapping,r,r.fields);else{if(!r.fields)throw new Error("transport.schema.model.fields/esMapping must be set");v.fill(r.fields,r)}var n=v.nestedFields(v),a=s(n,2),o=a[0],l=a[1];e.transport.parameterMap=function(t){var n=i.prepareParams(t.sort,t.group,t.columns),s={};return t.skip&&(s.from=t.skip),t.take&&(s.size=t.take),e.aggregationsOnly&&(s.from=0,s.size=0),s.sort=i.kendo2es(n,r.fields),s.query={filtered:{filter:c.kendo2es(t.filter||[],r.fields)}},s.inner_hits=p.innerHits(o,r.esMappingKey,l,s.sort,s.query.filtered.filter),s._source=Object.keys(r.fields).filter(function(e){return!r.fields[e].esNestedPath&&!r.fields[e].esParentType&&!r.fields[e].esChildType}).map(function(e){return r.fields[e].esName}),s.aggs=d.kendo2es(t.aggregate,r.fields,o,r.esMappingKey,s.query.filtered.filter),u.kendo2es(s.aggs,t.group,r.fields,o,r.esMappingKey,s.query.filtered.filter),JSON.stringify(s)};var f=e.schema;f.parse=function(t){var n=y.fromHits(t.hits.hits,r.fields);t.aggregations&&(t.aggregations.doc_count=t.hits.total);var s=d.es2kendo(t.aggregations),a=u.es2kendo(n,t.aggregations,r.fields,e.aggregationsOnly);return{total:t.hits.total,data:n,aggregates:s,groups:a}},f.aggregates=function(e){return e.aggregates},f.groups=function(e){return e.groups},f.data=f.data||"data",f.total=f.total||"total",f.model.id=f.model.id||"_id",e.serverFiltering=!0,e.serverSorting=!0,e.serverPaging=!0,e.serverAggregates=!0,e.serverGrouping=!0,_.DataSource.fn.init.call(this,e)}}),_.ElasticSearchDataSource.kendoFieldsFromESMapping=v.fromMapping},function(e,t){"use strict";function r(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function n(e,t,n){return e.filter(function(e){var r=t[e.field];return!!r&&(r.esNestedPath===n||r.esParentType===n||r.esChildType===n)}).map(function(e){return r({},t[e.field].esFilterName,{order:e.dir,missing:"_last",mode:"asc"===e.dir?"min":"max"})})}function s(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=[];e&&e.constructor===Array?r=e:e&&r.push(e);var n=[];return t.forEach(function(e){var t=r.filter(function(t){return t.field===e.field});t.length?(n.push(t[0]),r.splice(r.indexOf(t[0]),1)):n.push({field:e.field,dir:e.dir||"asc"})}),n=n.concat(r)}Object.defineProperty(t,"__esModule",{value:!0});t.kendo2es=n,t.prepareParams=s},function(e,t,r){"use strict";function n(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t["default"]=e,t}function s(e,t,r,n,s,i){var o=[e],u=null;t.forEach(function(e){var t=r[e.field],l=a(e,r,n,s,i),d={};t.esNestedPath&&0!==t.esNestedPath.indexOf(u)?(d[t.esNestedPath+"_nested"]=d[t.esNestedPath+"_nested"]||{nested:{path:t.esFullNestedPath},aggs:{}},d[t.esNestedPath+"_nested"].aggs[e.field+"_group"]=l.group,d[t.esNestedPath+"_nested"].aggs[e.field+"_missing"]=l.missing):(d[e.field+"_group"]=l.group,d[e.field+"_missing"]=l.missing),o.forEach(function(e){Object.keys(d).forEach(function(t){e[t]=d[t]})}),o=Object.keys(l).map(function(e){return l[e].aggregations}),u=t.esNestedPath})}function a(e,t,r,n,s){var a=t[e.field],i={},o={},u=void 0,l=[];(e.aggregates||[]).forEach(function(t){t.field===e.field&&"string"!==a.type?u=t:l.push(t)}),u?(i[u.aggregate]={field:a.esAggName},u.interval&&(i[u.aggregate].interval=u.interval)):i.terms={field:a.esAggName,size:0},o.missing={field:a.esAggName};var f=d.kendo2es(l,t,r,n,s,a.esNestedPath);return i.aggregations=f,o.aggregations=f,{group:i,missing:o}}function i(e,t){var r=Object.keys(e).filter(function(e){return"_group"===e.substr(e.length-6)}).map(function(r){var n=r.substr(0,r.length-6);return t&&(e[n+"_missing"].doc_count+=t),{group:e[r],missing:e[n+"_missing"],fieldKey:n}});return Object.keys(e).filter(function(e){return"_nested"===e.substr(e.length-7)}).forEach(function(t){var n=e.doc_count-e[t].doc_count;r=r.concat(i(e[t],n))}),r}function o(e,t,r,n){var s=[];if(t){var a=i(t);a.forEach(function(t){var a=[],i=u(t.group,t.missing,t.fieldKey);a=n?i.keys.map(function(e){return i.map[e]}):c.fillInGroups(i,e,r[t.fieldKey]);var l=!1;t.group.buckets&&t.group.buckets[0]&&Object.keys(t.group.buckets[0]).forEach(function(e){"_group"!==e.substr(e.length-6)&&"_nested"!==e.substr(e.length-7)||(l=!0)}),a.forEach(function(e){l&&(e.hasSubgroups=!0,e.items=o(e.items,e.bucket,r,n)),delete e.bucket}),s=s.concat(a)})}return s}function u(e,t,r){var n={},s=[];return e.buckets.forEach(function(e){var t=e.key_as_string||e.key;s.push(t),n[t]={field:r,value:t,hasSubgroups:!1,aggregates:d.es2kendo(e),items:[],bucket:e},n[t].aggregates[r]={count:e.doc_count}}),n[""]={field:r,value:"",hasSubgroups:!1,aggregates:d.es2kendo(t),items:[],bucket:t},n[""].aggregates[r]={count:t.doc_count},{map:n,keys:s}}Object.defineProperty(t,"__esModule",{value:!0}),t.es2kendo=t.kendo2es=void 0;var l=r(3),d=n(l),f=r(5),c=n(f);t.kendo2es=s,t.es2kendo=o},function(e,t,r){"use strict";function n(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t["default"]=e,t}function s(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments[1],r=arguments[2],n=arguments[3],s=arguments[4],a=arguments[5],i={};return e.forEach(function(e){var l=t[e.field],d=l.esNestedPath,f=i;a!==d&&!function(){var e=[];a&&0!==d.indexOf(a)?(i.group_reverse_nested=i.group_reverse_nested||{reverse_nested:{},aggregations:{}},f=i.group_reverse_nested.aggregations):a&&(d=d.substr(a.length+1,d.length)),d.split(".").forEach(function(t){e.push(t);var i=a?a+"."+e.join("."):e.join("."),u=n?n+"."+i:i,l=r[i];l&&(f[i]||(f[i+"_filter_nested"]=f[i+"_filter_nested"]||{nested:{path:u},aggregations:{}},f[i+"_filter_nested"].aggregations[i+"_filter"]=f[i+"_filter_nested"].aggregations[i+"_filter"]||{filter:o.innerHitsFilter(u,null,s),aggregations:{}}),f=f[i+"_filter_nested"].aggregations[i+"_filter"].aggregations)})}(),f[e.field+"_"+e.aggregate]={},f[e.field+"_"+e.aggregate][u[e.aggregate]]={field:l.esAggName}}),i}function a(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object.keys(e).forEach(function(r){e[r]&&(["count","min","max","average","sum"].forEach(function(n){var s=n.length+1;if(r.substr(r.length-s)==="_"+n){var a=r.substr(0,r.length-s);t[a]=t[a]||{},t[a][n]=e[r].value}}),"_nested"!==r.substr(r.length-7)&&"_filter"!==r.substr(r.length-7)||a(e[r],t))}),t}Object.defineProperty(t,"__esModule",{value:!0}),t.es2kendo=t.kendo2es=void 0;var i=r(4),o=n(i),u=(t.kendo2es=s,t.es2kendo=a,{count:"cardinality",min:"min",max:"max",sum:"sum",average:"avg"})},function(e,t){"use strict";function r(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function n(e,t,n,a,i){var o={};return Object.keys(e).forEach(function(n){var u=o,l=[];n.split(".").forEach(function(o){l.push(o);var d=l.join("."),f=t?t+"."+d:d,c=e[d];c&&(u[d]||(u[d]={path:r({},f,{_source:c,size:1e4,sort:a,query:{filtered:{filter:s(f,null,i)}}})}),d!==n&&(u[d].path[f].inner_hits=u[d].path[f].inner_hits||{},u=u[d].path[f].inner_hits))})}),Object.keys(n).forEach(function(e){var t=n[e];o[e]={type:r({},e,{_source:t,size:1e4,sort:a,query:{filtered:{filter:s(null,e,i)}}})}}),o}function s(e,t,r){r=$.extend(!0,{},r);var n=r.or||r.and;return n&&(n.filters=n.filters.filter(function(r){return r.and||r.or||r.nested&&r.nested.path===e||r.not&&r.not.nested&&r.not.nested.path===e||r.has_child&&r.has_child.type===t||r.not&&r.not.has_child&&r.not.has_child.type===t||r.has_parent&&r.has_parent.type===t||r.not&&r.not.has_parent&&r.not.has_parent.type===t}).map(function(t){return t.nested?t.nested.filter:t.not&&t.not.nested?{not:t.not.nested.filter}:t.has_child?t.has_child.filter:t.not&&t.not.has_child?{not:t.not.has_child.filter}:t.has_parent?t.has_parent.filter:t.not&&t.not.has_parent?{not:t.not.has_parent.filter}:s(e,t)})),r}Object.defineProperty(t,"__esModule",{value:!0});t.innerHits=n,t.innerHitsFilter=s},function(e,t){"use strict";function r(e,t,r){var n=[];return t.forEach(function(t){var s=e.map[t[r.key]||""];if(!s)for(var a="date"===r.type?new Date(t[r.key]):t[r.key],i=0;i<e.keys.length;i++){var o="date"===r.type?new Date(e.keys[i]):e.keys[i];if(a>=o){var u=e.keys[i+1]&&("date"===r.type?new Date(e.keys[i+1]):e.keys[i+1]);(!u||a<u)&&(s=e.map[e.keys[i]])}}if(!s)throw new Error("No group found, val: "+t[r.key]+" field: "+r.key);s.items.push(t),1===s.items.length&&n.push(s)}),n}function n(e,t){var r=[],s=e[t[0]];return void 0===s?[]:(t.length>1?$.isArray(s)?s.forEach(function(e){r=r.concat(n(e,t.slice(1)))}):r=n(s,t.slice(1)):r=$.isArray(s)?s:[s],r)}function s(e,t,r){var i=[];return e.forEach(function(e){var a=e._source||{},o={};o.id=[e._id],Object.keys(t).filter(function(e){var n=t[e];return void 0===r?!(n.esNestedPath||n.esChildType||n.esParentType):n.esNestedPath===r||n.esChildType===r||n.esParentType===r}).forEach(function(e){var r=t[e],s=n(a,r.esNameSplit);if(r.duration&&!moment)throw new Error("Working on durations requires to load momentjs library");"beforeToday"===r.duration&&(s=s.map(function(e){return moment().startOf("day").diff(moment(e).startOf("day"),"days")})),"afterToday"===r.duration&&(s=s.map(function(e){return moment(e).startOf("day").diff(moment().startOf("day"),"days")})),s&&(r.esMultiSplit?s&&s.length?o[e]=s:o[e]=[null]:o[e]=s.join(r.esMultiSeparator||"\n"))});var u=[o];Object.keys(e.inner_hits||{}).forEach(function(r){var n=s(e.inner_hits[r].hits.hits,t,r),a=[];u.forEach(function(e){n.length?n.forEach(function(t){var r={};Object.keys(t).forEach(function(e){r[e]=t[e]}),Object.keys(e).forEach(function(t){r[t]=e[t]}),a.push(r)}):a.push(e)}),u=a}),i=i.concat(u)}),a(i)}function a(e){var t=[];return e.forEach(function(e){var r=[{}];Object.keys(e).forEach(function(t){var n=[];e[t]&&e[t].constructor===Array?e[t].forEach(function(e){r.forEach(function(r){var s={};Object.keys(r).forEach(function(e){return s[e]=r[e]}),s[t]=e,n.push(s)})}):r.forEach(function(r){r[t]=e[t],n.push(r)}),r=n}),t=t.concat(r)}),t}Object.defineProperty(t,"__esModule",{value:!0});t.fillInGroups=r,t.fromHits=s},function(e,t){"use strict";function r(e,t){var s=void 0,a="and";if(e.operator)s=[e];else if(e.logic)a=e.logic,s=e.filters||[];else{if(e.constructor!==Array)throw new Error("Unsupported filter object: "+e);s=e}var i=[],o={};s.forEach(function(e){if(e.logic)i.push(r(e,t));else{var s=t[e.field];if(!s)throw new Error("Unknown field in filter: "+e.field);var u={query:{query_string:{query:n(e,t),analyze_wildcard:!0}}};if(s.esNestedPath){var l=o[s.esNestedPath]||{nested:{path:s.esFullNestedPath,filter:{}}};l.nested.filter[a]=l.nested.filter[a]||{filters:[]},l.nested.filter[a].filters.push(u),u=o[s.esNestedPath]?null:o[s.esNestedPath]=l}else s.esParentType?u={has_parent:{type:s.esParentType,filter:u}}:s.esChildType&&(u={has_child:{type:s.esChildType,filter:u}});u&&i.push(u)}});var u={};return u[a]={filters:i},u}function n(e,t){e.operator=e.operator||"eq";var r=t[e.field];if(r.duration&&!moment)throw new Error("Working on durations requires to load momentjs library");"beforeToday"===r.duration&&(e.value=moment().startOf("day").subtract(e.value,"days").format(),"lt"===e.operator?e.operator="gt":"lte"===e.operator?e.operator="gte":"gt"===e.operator?e.operator="lt":"gte"===e.operator&&(e.operator="lte")),"afterToday"===r.duration&&(e.value=moment().startOf("day").add(e.value,"days").format());var n=void 0;n="search"===e.operator?r.esSearchName:r.esFilterName;var a=s(n),i=s(e.value,e.operator),o={eq:"",search:"",lt:"<",lte:"<=",gt:">",gte:">="};if(void 0!==o[e.operator]){var u=o[e.operator];return a+":"+u+i}var l=void 0;switch(e.operator){case"neq":return"NOT ("+a+":"+i+")";case"contains":return"("+a+":*"+i+"*)";case"doesnotcontain":return"NOT ("+a+":*"+i+"*)";case"startswith":return a+":"+i+"*";case"endswith":return a+":*"+i;case"missing":if(r.esNestedPath||r.esParentType||r.esChildType)throw new Error("missing filter is not supported on nested fields");return l="_missing_:"+a,"string"===r.type&&(l+=" OR ("+a+':"")'),l;case"exists":return l="_exists_:"+a,"string"===r.type&&(l+=" AND NOT("+a+':"")'),l;default:throw new Error("Unsupported Kendo filter operator: "+e.operator)}}function s(e,t){return e.constructor===Date?e=e.toISOString():"boolean"!=typeof e&&"number"!=typeof e||(e=""+e),"search"===t?(e=e.replace("\\","\\\\"),(e.match(/"/g)||[]).length%2===1&&(e=e.replace(/"/g,'\\"')),e=e.replace(i,"\\$&")):e.replace("\\","\\\\").replace(a,"\\$&")}Object.defineProperty(t,"__esModule",{value:!0});var a=(t.kendo2es=r,/[+\-&|!()\{}\[\]^:"~*?:\/ ]/g),i=/[+\-&|!()\{}\[\]^:~:\/]/g},function(e,t){"use strict";function r(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",o=arguments[4],u=arguments[5];return Object.keys(e.properties||{}).forEach(function(n){var l=e.properties[n],d=s(n),f=i?i+"_"+d:d,c=o?o+"."+n:n;if("nested"===l.type){var g=u?u+"."+c:c;r(l,t,a,f,"",g)}else if(l.properties)r(l,t,a,f,c,u);else if("object"===l.type);else{var p=a[f]=a[f]||{};p.esNestedPath||(p.type=p.type||l.type,["float","double","integer","long","short","byte"].indexOf(p.type)!==-1&&(p.type="number"),"string"!==p.type&&(p.esMultiSplit=!0),u&&(p.esNestedPath=u),p.esName=c,"not_analyzed"===l.index&&(p.esSearchSubField=null,p.esFilterSubField=null,p.esAggSubField=null))}}),n(a,t),a}function n(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};for(var r in e)if(e.hasOwnProperty(r)){var n=e[r];n.key=r,n.esName=n.esName||r,n.esNameSplit=n.esName.split("."),n.esNestedPath&&(n.esFullNestedPath=n.esNestedPath,t.esMappingKey&&(n.esFullNestedPath=t.esMappingKey+"."+n.esFullNestedPath)),n.esSearchName||(n.esSearchName=n.esName,n.hasOwnProperty("esSearchSubField")?n.esSearchSubField&&(n.esSearchName+="."+n.esSearchSubField):"string"===n.type&&t.esStringSubFields&&t.esStringSubFields.search&&(n.esSearchName+="."+t.esStringSubFields.search),n.esNestedPath&&(n.esSearchName=n.esNestedPath+"."+n.esSearchName)),n.esFilterName||(n.esFilterName=n.esName,n.hasOwnProperty("esFilterSubField")?n.esFilterSubField&&(n.esFilterName+="."+n.esFilterSubField):"string"===n.type&&t.esStringSubFields&&t.esStringSubFields.filter&&(n.esFilterName+="."+t.esStringSubFields.filter),n.esNestedPath&&(n.esFilterName=n.esNestedPath+"."+n.esFilterName)),n.esAggName||(n.esAggName=n.esName,n.hasOwnProperty("esAggSubField")?n.esAggSubField&&(n.esAggName+="."+n.esAggSubField):"string"===n.type&&t.esStringSubFields&&t.esStringSubFields.agg&&(n.esAggName+="."+t.esStringSubFields.agg),n.esNestedPath&&(n.esAggName=n.esFullNestedPath+"."+n.esAggName))}}function s(e){return e.replace(/[^a-zA-z0-9_$]/g,"_")}function a(e){var t={},r={};return Object.keys(e).forEach(function(n){var s=e[n];s.esNestedPath&&(t[s.esNestedPath]=t[s.esNestedPath]||[],t[s.esNestedPath].push(s.esName)),s.esParentType&&(r[s.esParentType]=r[s.esParentType]||[],r[s.esParentType].push(s.esName)),s.esChildType&&(r[s.esChildType]=r[s.esChildType]||[],r[s.esChildType].push(s.esName))}),[t,r]}Object.defineProperty(t,"__esModule",{value:!0});t.fromMapping=r,t.fill=n,t.nestedFields=a}])});
//# sourceMappingURL=kendo-elasticsearch.min.js.map